<!DOCTYPE html>
<html>
<head>
  <title>Code Sandbox</title>
  <script>
    window.addEventListener('message', (event) => {
      if (event.source !== window.parent) {
        return;
      }

      const { code, testCases } = event.data;
      const results = [];

      for (const testCase of testCases) {
        let output = '';
        let error = null;
        let passed = false;

        // Redirect console.log to capture output
        const originalConsoleLog = console.log;
        console.log = (...args) => {
          output += args.map(arg => typeof arg === 'string' ? arg : JSON.stringify(arg)).join(' ') + '\n';
        };

        try {
          // Create a new function to execute the user's code
          // This is still within the iframe sandbox, so it's safer than on the server
          const fullCode = `${testCase.input || ''}\n${code}`;
          const runnable = new Function(fullCode);
          runnable();
          passed = output.trim() === testCase.expected.trim();
        } catch (e) {
          error = e.message;
          passed = false;
        } finally {
          console.log = originalConsoleLog; // Restore console.log
        }
        results.push({ ...testCase, actual: output.trim(), error, passed });
      }
      
      window.parent.postMessage({ type: 'code_execution_result', results }, event.origin);
    });
  </script>
</head>
<body>
  <!-- This body will be empty, as all logic runs in script -->
</body>
</html>